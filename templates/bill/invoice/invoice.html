{% extends 'template.html' %}

{% load static %}

{% block style %}
	<style>
        th {
            padding: 0.2rem 0.5rem;
        }

        td {

        }
	</style>
{% endblock %}

{% block content %}
	<nav aria-label="breadcrumb">
		<ol class="breadcrumb bg-primary">
			<li class="breadcrumb-item"><a href={{ breadcrumb.0 }}>Organization</a></li>
			<li class="breadcrumb-item active" aria-current="page">Generate Invoice</li>
		</ol>
	</nav>
	<div class="card">
		<div class="card-body">
			<h4 class="card-title">Invoice Form</h4>

			<form class="forms-invoice" method="post" action={% url "invoice" %}>
				{% csrf_token %}
				<div class="row">
					<div class="col-6 form-group">
						<label for="vendor_name">Vendor Name</label>
						<input type="text" class="form-control" id="vendor_name" placeholder="Vendor Name"
							   name="vendor_name" required>
					</div>
					<div class="col-6 form-group">
						<label for="vendor_phone">Vendor Contact Number</label>
						<input type="tel" class="form-control" id="vendor_phone" placeholder="Vendor Contact Number"
							   name="vendor_phone" required>
					</div>
				</div>
				<div class="row">
					<div class="col-6 form-group">
						<label for="vendor_gstin">Vendor GSTIN <span
								id="gstin-validation-message"></span></label>
						<input type="text" class="form-control" id="vendor_gstin" placeholder="Vendor GST"
							   name="vendor_gstin">
					</div>
					<div class="col-6 form-group">
						<label for="vendor_pincode">Vendor Pincode </label>
						<input type="tel" class="form-control" id="vendor_pincode" placeholder="Vendor Contact Pincode"
							   name="vendor_pincode" required>
					</div>
				</div>
				<div class="row">
					<div class="col-6 form-group">
						<label for="vendor_city">Vendor City </label>
						<input type="text" class="form-control" id="vendor_city" placeholder="Vendor City"
							   name="vendor_city" readonly>
					</div>
					<div class="col-6 form-group">
						<label for="vendor_state">Vendor State </label>
						<input type="tel" class="form-control" id="vendor_state" placeholder="Vendor State"
							   name="vendor_state" readonly>
					</div>
				</div>
				<div class=" form-group">
					<label for="vendor_address">Vendor Address </label>
					<textarea class="form-control" id="vendor_address" placeholder="Vendor Address"
							  name="vendor_address"></textarea>
				</div>


				<div class="table-responsive ">
					<hr>
					<p class="card-description">Invoice Items</p>

					<table class="table invoice_data_repeater" style="width:100%">
						<thead>
						<tr>
							<th style="width: 9%; padding: 0.2rem 0.5rem;">Barcode</th>
							<th style="width: 17%; padding: 0.2rem 0.5rem;">Item Name</th>
							<th style="width: 14%; padding: 0.2rem 0.5rem;">Description</th>
							<th style="width: 7%; padding: 0.2rem 0.5rem;">HSN</th>
							<th style="width: 7%; padding: 0.2rem 0.5rem;">SKU</th>
							<th style="width: 7%; padding: 0.2rem 0.5rem;">Qty</th>
							<th style="width: 11%; padding: 0.2rem 0.5rem;">Rate</th>
							<th style="width: 6%; padding: 0.2rem 0.5rem;">GST</th>
							<th style="width: 6%; padding: 0.2rem 0.5rem;">Discount</th>
							<th style="width: 11%; padding: 0.2rem 0.5rem;">Price</th>
							<th style="width: 8%; padding: 0.2rem 0.5rem;">Action</th>
						</tr>
						</thead>
						<tbody data-repeater-list="invoice_items">

						<tr class="invoice_item" data-repeater-item id="invoice_data_1">
							<td style="padding: 0.2rem 0.5rem;"><input class="form-control form-control-sm px-1"
																	   type="text" name="barcode" min="0"></td>

							<td style="padding: 0.2rem 0.5rem;">
								<select class="form-control form-control-sm px-1" name="product"
										onchange="product_name(this)"
										required>
									<option value="" selected></option>

									<option value="other">Create Product</option>
								</select>
							</td>
							<td style="padding: 0.2rem 0.5rem;"><input class="form-control form-control-sm px-1"
																	   type="text" name="description"
																	   placeholder="Description" readonly></td>
							<td style="padding: 0.2rem 0.5rem;"><input class="form-control form-control-sm px-1"
																	   type="text" name="hsn"
																	   placeholder="HSN" readonly></td>
							<td style="padding: 0.2rem 0.5rem;"><input class="form-control form-control-sm px-1"
																	   type="text" name="sku"
																	   placeholder="SKU" readonly></td>
							<td style="padding: 0.2rem 0.5rem;"><input class="form-control form-control-sm qty px-1"
																	   type="text" name="qty"
																	   placeholder="Qty" min="1" value="1"></td>
							<td style="padding: 0.2rem 0.5rem;"><input class="form-control form-control-sm rate px-1"
																	   type="text" name="rate"
																	   placeholder="Rate" min="0"></td>
							<td style="padding: 0.2rem 0.5rem;"><input class="form-control form-control-sm gst px-1"
																	   type="text" name="gst"
																	   placeholder="Gst" min="0" max="100" readonly>
							</td>
							<td style="padding: 0.2rem 0.5rem;"><input
									class="form-control form-control-sm discount px-1" type="text" name="discount"
									placeholder="Disc" min="0" max="100"></td>
							<td style="padding: 0.2rem 0.5rem;"><input class="form-control form-control-sm price  px-1"
																	   type="text" name="price"
																	   placeholder="Price" onchange="calculate_total()"
																	   min="0" readonly></td>
							<td style="padding: 0.2rem 0.5rem;">
								<button type="button" class="btn btn-danger btn-rounded btn-icon" data-repeater-delete>
									<i class="mdi mdi-delete"></i></button>
								<button type="button" class="btn btn-success btn-rounded btn-icon" data-repeater-create>
									<i class="mdi mdi-plus"></i></button>

							</td>
						</tr>

						</tbody>
						<tfoot>
						<tr>
							<td></td>
							<td></td>
							<td></td>
							<td></td>
							<td></td>
							<td></td>
							<td></td>
							<td></td>

							<td><strong>Total - </strong></td>
							<td style="padding: 0.2rem 0.5rem;"><input class="form-control form-control-sm px-1"
																	   type="text" id="total" name="total"
																	   placeholder="Total" min="0"
																	   readonly></td>
							<td></td>

						</tr>
						</tfoot>
					</table>

				</div>
				<hr>
				<p class="card-description">Invoice Description</p>

				<div class="payments">
					<div class="row">
						<div class="col-11 ">
							<div class="form-check form-check-flat form-check-primary">
								<label class="form-check-label">
									<input type="checkbox" class="form-check-input" id="partial-payment"
										   name="partial-payment">
									Partial Payments
									<i class="input-helper"></i>
								</label>
							</div>
						</div>
						<div class="col-1">
							<button data-repeater-create type="button"
									class="partial_btn btn btn-success btn-rounded btn-icon">
								<i class="mdi mdi-plus"></i>
							</button>
						</div>
					</div>
					<div class="" data-repeater-list="payment">
						<div class="row" data-repeater-item id="partials_1">
							<div class="col-6 form-group">
								<label for="payment-type">Payment Type</label>
								<select class="form-control form-control-sm w-100" name="payment-type">
									<option value="Cash" selected>Cash</option>
									<option value="Upi">UPI</option>
									<option value="Debit Card">Debit Card</option>
									<option value="Credit Card">Credit Card</option>
									<option value="Finance">Finance</option>
									<option value="Credit">Credit</option>
								</select>
							</div>
							<div class="col-5 form-group">
								<label for="payment-amt">Payment Amount</label>
								<input class="form-control form-control-sm" type="number" name="payment-amt"
									   placeholder="Amount Paid">
							</div>
							<div class="col-1">
								<button data-repeater-delete type="button"
										class="partial_btn btn btn-danger btn-rounded btn-icon">
									<i class="mdi mdi-delete"></i>
								</button>
							</div>
						</div>
						<div class="partial_payment"></div>
					</div>
				</div>
				<div class="transport_module">
					<div class="form-check form-check-flat form-check-primary">
						<label class="form-check-label">
							<input type="checkbox" class="form-check-input" id="transport" name="transport_status">
							Transportation
							<i class="input-helper"></i></label>
					</div>
					<div class="transport">
						<div class="row">
							<div class="col-6 form-group">
								<label for="transporter_name">Transporter Name</label>
								<input type="text" class="form-control" id="transporter_name"
									   placeholder="Transporter Name"
									   name="transporter_name" required>
							</div>
							<div class="col-6 form-group">
								<label for="transporter_phone">Transporter Number</label>
								<input type="text" class="form-control" id="transporter_phone"
									   placeholder="Transporter Contact Number"
									   name="transporter_phone" required>
							</div>
						</div>
						<div class="row">
							<div class="col-6 form-group">
								<label for="transporter_vehicle">Transporter Vehicle Number</label>
								<input type="text" class="form-control" id="transporter_vehicle"
									   placeholder="Transporter Vehicle Number"
									   name="transporter_vehicle" required>
							</div>
							<div class="col-6 form-group">
								<label for="transporter_id">Transporter ID</label>
								<input type="text" class="form-control" id="transporter_id" placeholder="Transporter ID"
									   name="transporter_id">
							</div>
						</div>
						<div class="row">
							<div class="col-6 form-group">
								<label for="transport_amt">Transport Amount Paid</label>
								<input type="number" class="form-control" id="transport_amt"
									   placeholder="Transport Amount Paid"
									   name="transport_amt">
							</div>
						</div>
					</div>
				</div>
				<br>
				<br>

				<button type="submit" class="btn btn-primary mr-2">Submit</button>
				<button href={% url "organization" %} class="btn btn-light
				">Cancel</button>
			</form>
		</div>
	</div>
{% endblock %}

{% block script %}
	<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

	<script src={% static "vendors/jquery.repeater/jquery.repeater.min.js" %}></script>
	<script src={% static "js/form-repeater.js" %}></script>
	<script>

        function toggleTransportDiv() {
            var checkbox = document.getElementById("transport");
            var transportDiv = document.querySelector(".transport");
            var inputFields = transportDiv.querySelectorAll("input");

            if (checkbox.checked) {
                transportDiv.style.display = "block";
                inputFields.forEach(function (input) {
                    input.disabled = false;
                });
            } else {
                transportDiv.style.display = "none";
                inputFields.forEach(function (input) {
                    input.disabled = true;
                });
            }
        }

        var checkbox = document.getElementById("transport");
        checkbox.addEventListener("change", toggleTransportDiv);

        toggleTransportDiv();

        function togglePartialPaymentDiv() {
            var checkbox = document.getElementById("partial-payment");
            var partialPaymentDiv = document.querySelector(".partial_payment");
            var inputFields = partialPaymentDiv.querySelectorAll("input");
            var selectFields = partialPaymentDiv.querySelectorAll("select");

    		var partialInputs = document.getElementById("partials_1").querySelectorAll("input")[0];


            var partialBtn = document.querySelector(".partial_btn");

            if (checkbox.checked) {
                partialPaymentDiv.style.display = "block";
                partialBtn.style.display = "block";

				partialInputs.value = 0;
				partialInputs.readOnly = false;

                inputFields.forEach(function (input) {
                    input.disabled = false;
                                        input.readOnly = false;

                });
                selectFields.forEach(function (select) {
                    select.disabled = false;


                });
            } else {

                partialPaymentDiv.style.display = "none";
                partialBtn.style.display = "none";

                partialInputs.value = document.getElementById("total").value;
				partialInputs.readOnly = true;

                inputFields.forEach(function (input) {
                    input.disabled = true;
                });
                selectFields.forEach(function (select) {
                    select.disabled = true;
                });

            }
        }

        var checkbox = document.getElementById("partial-payment");
        checkbox.addEventListener("change", togglePartialPaymentDiv);

        togglePartialPaymentDiv();


        function validateGSTIN(gstin) {
            if (gstin === "") {
                return true;
            }
            var gstinRegex = /^\d{2}[A-Z]{5}\d{4}[A-Z]{1}[1-9A-Z]{1}Z[A-Z\d]{1}$/;
            return gstin.match(gstinRegex) !== null;
        }

        function handleInputChange() {
            var inputElement = document.getElementById("vendor_gstin");
            var validationMessage = document.getElementById("gstin-validation-message");
            if (inputElement.value == "") {
                validationMessage.textContent = "";
                validationMessage.style.color = "";
            } else if (validateGSTIN(inputElement.value)) {
                validationMessage.textContent = "(Valid GSTIN)";
                validationMessage.style.color = "green";
            } else {
                validationMessage.textContent = "(Invalid GSTIN. Please enter a valid GSTIN.)";
                validationMessage.style.color = "red";
            }
        }

        function handleFormSubmit(event) {
            var inputElement = document.getElementById("vendor_gstin");
            if (!validateGSTIN(inputElement.value)) {
                event.preventDefault();
                alert("Please enter a valid GSTIN before submitting.");
            }
        }

        var gstinInput = document.getElementById("vendor_gstin");
        gstinInput.addEventListener("input", handleInputChange);

        var organizationForm = document.getElementById("vendor_gstin");
        organizationForm.addEventListener("submit", handleFormSubmit);

        $(document).ready(function () {
            $('#vendor_pincode').blur(function () {
                var pincode = $(this).val();
                if (pincode.length == 6) {
                    $.ajax({
                        url: 'https://api.postalpincode.in/pincode/' + pincode,
                        type: 'GET',
                        success: function (result) {
                            if (result[0].Status == 'Success') {
                                var city = result[0].PostOffice[0].District;
                                var state = result[0].PostOffice[0].State;
                                $('#vendor_city').val(city);
                                $('#vendor_state').val(state);
                            }
                        }
                    });
                }
            });
        });
	</script>
	<script>
        function product_name(element) {
            var parentId = $(element).closest('tr').attr('id');
            if ($(element).val() === 'other') {
                var name = $(element).attr('name')
				name = name.replace("product", "name");
                var newInput = $('<input>', {
                    class: 'form-control form-control-sm',
                    type: 'text',
                    name: name,
                    placeholder: 'Product Name',
                    required: true,
                });
                $(element).replaceWith(newInput);
                $('#' + parentId + ' input').not('.price').removeAttr('readonly');

            }
        }
	</script>

	<script>
        function calculateRowPrice(row) {
            const qty = parseFloat(row.find('.qty').val()) || 0;
            const rate = parseFloat(row.find('.rate').val()) || 0;
            const gst = parseFloat(row.find('.gst').val()) || 0;
            const discount = parseFloat(row.find('.discount').val()) || 0;

            // Calculate the price for this row with discount
            var price = (qty * rate) + (qty * rate * gst / 100);
            price -= (discount / 100) * price; // Apply discount

            // Update the price input field
            row.find('.price').val(price.toFixed(2));
        }

        // Function to calculate total
        function calculate_total() {
            let total = 0;

            $('.invoice_item').each(function () {
                calculateRowPrice($(this));
                const rowPrice = parseFloat($(this).find('.price').val()) || 0;
                total += rowPrice;
            });

            // Update the #total element
            document.getElementById("total").value = total.toFixed(2);
            var partialInputs = document.getElementById("partials_1").querySelectorAll("input")[0];
            partialInputs.value = total.toFixed(2);
			partialInputs.readOnly = true;


        }

        // Attach event handlers to the inputs
        $(document).on('change', '.qty, .rate, .gst, .discount', function () {
            calculateRowPrice($(this).closest('.invoice_item'));
            calculate_total();
        });


	</script>
	<script>
        (function ($) {
            $(function () {
                $('.invoice_data_repeater').repeater({
                    show: function () {
                        // Generate a unique ID for the item
                        var uniqueId = 'invoice_data_' + $('.invoice_data_repeater .invoice_item').length;

                        // Set the unique ID as an attribute for the item
                        $(this).attr('id', uniqueId);
                        $(this).slideDown("");
                        $(this).find('.btn-success[data-repeater-create]').remove();
                    },
                    hide: function (deleteElement) {

                        if (confirm('Are you sure you want to delete this element?')) {
                            $(this).slideUp(function (){
                                deleteElement();
								calculate_total();
							});
                        }

                    },
                    isFirstItemUndeletable: true
                });
            });
        })(jQuery);

        (function ($) {
            $(function () {
                $('.payments').repeater({
                    show: function () {
                        var uniqueId = 'partials_' + ($('.payments .row[data-repeater-item]').length);
                        var newItem = $(this);
                        newItem.attr('id', uniqueId);
                        newItem.appendTo('.partial_payment').slideDown();

                        newItem.find('label').remove();
						newItem.find('input').prop('readonly', false);
                        newItem.find('input').prop('value', 0);
                        newItem.find('.btn-success[data-repeater-create]').remove();
                    },
                    hide: function (deleteElement) {
                        if (confirm('Are you sure you want to delete this element?')) {
                            // Slide up and delete the element if confirmed
                            $(this).slideUp(function () {
                                $(this).remove();
                            });
                        }
                    },
                    isFirstItemUndeletable: true
                });
            });
        })(jQuery);

	</script>


{% endblock %}